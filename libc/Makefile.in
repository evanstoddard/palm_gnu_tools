# Makefile for prc-tools libc.
#
# This is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.

# This Makefile is currently something of a hack job.  There's piles of
# commented out stuff at the bottom there, and the corresponding source
# files aren't used yet, and are down in the exp(erimental) directory.
# There's a way to go before this libc provides anything like ISO C
# functionality.

srcdir = @srcdir@
VPATH = @srcdir@
#stop

prefix = @prefix@
exec_prefix = @exec_prefix@
target_alias = @target_alias@

INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@

SDKFLAGS =
MULTIFLAGS =

CC = $(target_alias)-gcc
AR = $(target_alias)-ar
RANLIB = $(target_alias)-ranlib

INSTALL_DIRS  = $(INSTALL_DIRS_@target_cpu@)
INSTALL_FILES = $(INSTALL_FILES_@target_cpu@)
LIBC_OBJS = $(LIBC_OBJS_@target_cpu@)
LIBG_OBJS = $(LIBG_OBJS_@target_cpu@)

# PRINT_FLOATS huh?
CFLAGS = -Wall -O2 -fno-builtin -DPRINT_FLOATS \
  -I$(srcdir)/include -I$(srcdir)/../include $(SDKFLAGS) $(MULTIFLAGS)

INSTALL_DIR = $(exec_prefix)/$(target_alias)

INCDIR = $(srcdir)/include
INSTALL_HFILES = $(INCDIR)/ctype.h $(INCDIR)/errno.h $(INCDIR)/malloc.h \
		 $(INCDIR)/setjmp.h $(INCDIR)/stdio.h $(INCDIR)/string.h \
		 $(INCDIR)/stdlib.h $(INCDIR)/sys/types.h


INSTALL_DIRS_m68k  = lib/mown-gp
INSTALL_FILES_m68k = libc.a mown-gp/libc.a libg.a mown-gp/libg.a libstdc++.a

LIBC_OBJS_m68k = \
	conio.o vsprintf.o printf.o ctype.o setjmp.o \
	bcopy.o memmove.o strchr.o strncat.o strspn.o \
	memscan.o strcmp.o strncmp.o strstr.o \
	memset.o strcpy.o strncpy.o strtok.o \
	malloc.o free.o realloc.o calloc.o \
	memcmp.o strnlen.o strtol.o \
	memcpy.o strcat.o strlen.o strpbrk.o strtoul.o \
	abort.o atexit.o bzero.o

LIBG_OBJS_m68k =


INSTALL_DIRS_arm  =
INSTALL_FILES_arm = libc.a libstdc++.a

LIBC_OBJS_arm = \
	memcpy.o memset.o

LIBG_OBJS_arm =


all: $(INSTALL_FILES)

install: $(INSTALL_FILES) $(INSTALL_HFILES)
	$(INSTALL) -d $(exec_prefix)/$(target_alias)/include
	$(INSTALL) -d $(exec_prefix)/$(target_alias)/include/sys
	for f in $(INSTALL_HFILES); do \
	  echo $${f}; \
	  $(INSTALL_DATA) $${f} `echo $${f} | sed -e 's:^$(INCDIR):$(exec_prefix)/$(target_alias)/include:'`; \
	done
	for d in lib $(INSTALL_DIRS); do \
	  $(INSTALL) -d $(exec_prefix)/$(target_alias)/$${d}; \
	done
	for f in $(INSTALL_FILES); do \
	  echo $${f}; \
	  $(INSTALL_DATA) $${f} $(exec_prefix)/$(target_alias)/lib/$${f}; \
	done

.c.s:
	$(CC) $(CFLAGS) -S $<

all-multilibs: libc.a libg.a

libc.a: $(LIBC_OBJS)
	rm -f libc.a
	$(AR) cur libc.a $(LIBC_OBJS)
	$(RANLIB) libc.a

mown-gp/libc.a: sub-multilibs

mown-gp/Makefile: Makefile
	if [ ! -d mown-gp ]; then mkdir mown-gp; fi
	sed '1,/^#stop/s,= \.,= ../.,' Makefile > mown-gp/Makefile

sub-multilibs: mown-gp/Makefile
	cd mown-gp; $(MAKE) CC="$(CC)" AR="$(AR)" RANLIB="$(RANLIB)" \
	  SDKFLAGS="$(SDKFLAGS)" MULTIFLAGS=-mown-gp all-multilibs


libg.a: $(LIBG_OBJS)
	rm -f libg.a
	$(AR) cur libg.a $(LIBG_OBJS)
	$(RANLIB) libg.a


# Yes, this library really is empty.  But we need it to exist to keep the
# linker happy if people link with m68k-palmos-g++.
libstdc++.a:
	$(AR) cur libstdc++.a
	$(RANLIB) libstdc++.a


.S.o:
	$(CC) $(TARGETFLAGS) $(SDKFLAGS) $(DEFINES) -c $<

clean:
	-rm -f *.[oa] Libc* libcstub* *.grc *.exp *.sa Libg* libgstub*

distclean: clean
	-rm Makefile

#div.o ldiv.o: division.c
#	$(CC) $(CFLAGS) -c -o $@ -DL`basename $@ .o` $<

malloc.o free.o calloc.o realloc.o: malloc.c include/stdlib.h ../include/NewTypes.h
	$(CC) $(CFLAGS) -c -o $@ -DL`basename $@ .o` $(srcdir)/malloc.c

#rand.o srand.o: random.c
#	$(CC) $(CFLAGS) -c -o $@ -DL`basename $@ .o` $<
#
#bmemcmp.o memcpy.o bcopy.o memset.o bzero.o: memory.S
#	$(CC) $(ASFLAGS) -c -o $@ -DL`basename $@ .o` $<
#
#strtol.o strtoul.o atoil.o: strtonum.S
#	$(CC) $(ASFLAGS) -c -o $@ -DL`basename $@ .o` $<

atexit.o: atexit.c include/stdlib.h ../include/NewTypes.h

conio.o: conio.c ../include/NewTypes.h
