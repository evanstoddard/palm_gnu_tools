# Makefile for prc-tools libc.
#
# This is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.

srcdir = @srcdir@
VPATH = @srcdir@
#stop

prefix = @prefix@
exec_prefix = @exec_prefix@
target_cpu = @target_cpu@
target_alias = @target_alias@
tooldir = $(exec_prefix)/$(target_alias)

INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@

SDKFLAGS =
MULTIFLAGS =

CC = $(target_alias)-gcc
AR = $(target_alias)-ar
RANLIB = $(target_alias)-ranlib

INSTALL_DIRS	= $(INSTALL_DIRS_@target_cpu@)
INSTALL_HEADERS	= $(INSTALL_HEADERS_@target_cpu@)
INSTALL_LIBS	= $(INSTALL_LIBS_@target_cpu@)

LIBC_OBJS = $(LIBC_OBJS_@target_cpu@)
LIBG_OBJS = $(LIBG_OBJS_@target_cpu@)

# PRINT_FLOATS huh?
CFLAGS = -Wall -O2 -fno-builtin -DPRINT_FLOATS \
  -I$(srcdir)/include -I$(srcdir)/../include $(SDKFLAGS) $(MULTIFLAGS)

INCDIR = $(srcdir)/include
INSTALL_HFILES = $(INCDIR)/ctype.h $(INCDIR)/errno.h $(INCDIR)/malloc.h \
		 $(INCDIR)/setjmp.h $(INCDIR)/stdio.h $(INCDIR)/string.h \
		 $(INCDIR)/sys/types.h


INSTALL_DIRS_m68k    = include lib lib/mown-gp
INSTALL_HEADERS_m68k = stdlib.h
INSTALL_LIBS_m68k    = libc.a mown-gp/libc.a libg.a mown-gp/libg.a libstdc++.a

LIBC_OBJS_m68k = \
	conio.o vsprintf.o printf.o ctype.o setjmp.o \
	bcopy.o memmove.o strchr.o strncat.o strspn.o \
	memscan.o strcmp.o strncmp.o strstr.o \
	memset.o strcpy.o strncpy.o strtok.o \
	malloc.o free.o realloc.o calloc.o \
	abs.o labs.o llabs.o div.o ldiv.o lldiv.o \
	memcmp.o strnlen.o strtol.o \
	memcpy.o strcat.o strlen.o strpbrk.o strtoul.o \
	abort.o atexit.o bzero.o

LIBG_OBJS_m68k =


INSTALL_DIRS_arm    = lib
INSTALL_HEADERS_arm =
INSTALL_LIBS_arm    = libc.a libstdc++.a

LIBC_OBJS_arm = \
	abs.o labs.o llabs.o div.o ldiv.o lldiv.o \
	memcpy.o memset.o

LIBG_OBJS_arm =


all: $(INSTALL_LIBS)

install-legacy: $(INSTALL_HFILES)
	$(INSTALL) -d $(exec_prefix)/$(target_alias)/include
	$(INSTALL) -d $(exec_prefix)/$(target_alias)/include/sys
	for f in $(INSTALL_HFILES); do \
	  echo $${f}; \
	  $(INSTALL_DATA) $${f} `echo $${f} | sed -e 's:^$(INCDIR):$(exec_prefix)/$(target_alias)/include:'`; \
	done

install: all install-legacy
	list="$(INSTALL_DIRS)"; for d in $$list; do \
	  $(INSTALL) -d $(tooldir)/$$d; \
	done
	list="$(INSTALL_HEADERS)"; for f in $$list; do \
	  $(INSTALL_DATA) $(srcdir)/$(target_cpu)/$$f $(tooldir)/include/$$f; \
	done
	list="$(INSTALL_LIBS)"; for f in $$list; do \
	  $(INSTALL_DATA) $$f $(tooldir)/lib/$$f; \
	done


bootstrap_h = ../bootstrap/bootstrap.h ../include/NewTypes.h

malloc.o free.o calloc.o realloc.o: malloc.c ../include/stdlib.h $(bootstrap_h)
	$(CC) $(CFLAGS) -c -o $@ -DL`basename $@ .o` $(srcdir)/malloc.c

atexit.o: atexit.c ../include/stdlib.h $(bootstrap_h)

abs.o labs.o llabs.o: abs.c ../include/stdlib.h
	$(CC) $(CFLAGS) -c -o $@ -DL`basename $@ .o` $(srcdir)/abs.c

div.o ldiv.o lldiv.o: division.c ../include/stdlib.h
	$(CC) $(CFLAGS) -c -o $@ -DL`basename $@ .o` $(srcdir)/division.c

conio.o: conio.c include/stdio.h $(bootstrap_h) ../bootstrap/bootstrap-ui.h


all-multilibs: libc.a libg.a

libc.a: $(LIBC_OBJS)
	rm -f libc.a
	$(AR) cur libc.a $(LIBC_OBJS)
	$(RANLIB) libc.a

mown-gp/libc.a: sub-multilibs

mown-gp/Makefile: Makefile
	if [ ! -d mown-gp ]; then mkdir mown-gp; fi
	sed '1,/^#stop/s,= \.,= ../.,' Makefile > mown-gp/Makefile

sub-multilibs: mown-gp/Makefile
	cd mown-gp; $(MAKE) CC="$(CC)" AR="$(AR)" RANLIB="$(RANLIB)" \
	  SDKFLAGS="$(SDKFLAGS)" MULTIFLAGS=-mown-gp all-multilibs


libg.a: $(LIBG_OBJS)
	rm -f libg.a
	$(AR) cur libg.a $(LIBG_OBJS)
	$(RANLIB) libg.a


# Yes, this library really is empty.  But we need it to exist to keep the
# linker happy if people link with m68k-palmos-g++.
libstdc++.a:
	$(AR) cur libstdc++.a
	$(RANLIB) libstdc++.a


.S.o:
	$(CC) $(TARGETFLAGS) $(SDKFLAGS) $(DEFINES) -c $<

clean:
	-rm -f *.o lib*.a
