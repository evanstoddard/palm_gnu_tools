# Makefile for prc-tools crt files.
#
# Copyright (c) 1998, 1999 Palm Computing, Inc. or its subsidiaries.
# All rights reserved.
#
# This is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.

srcdir = @srcdir@
VPATH = @srcdir@

prefix = @prefix@
exec_prefix = @exec_prefix@
target_alias = @target_alias@

INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@

CC = $(target_alias)-gcc
AR = $(target_alias)-ar
RANLIB = $(target_alias)-ranlib

SDK = @build_sdk@
SDK_NUMBER = @build_sdk_number@
# Don't use -fomit-frame-pointer just now: it's broken
# CFLAGS = -O5 -fomit-frame-pointer -fno-builtin -Wall -W
CFLAGS = -O5 -fno-builtin -Wall -W \
	 -DSDK_VERSION=$(SDK_NUMBER) -palmos$(SDK)

#INSTALL_FILES = crt0.o gcrt0.o scrt0.o libcrt.a libscrt.a libnoexcept.a
INSTALL_FILES = crt0.o gcrt0.o libcrt.a libnoexcept.a

CRTLIB_OBJS = \
  single_dreloc.o multi_dreloc.o multi_free.o reloc_chain.o \
  hooks.o gdbstub.o

SCRTLIB_OBJS = \
  palmos_GLib.o \
  ssingle_dreloc.o smulti_dreloc.o smulti_free.o sreloc_chain.o \
  hooks.o decompress.o


all: $(INSTALL_FILES)

install: $(INSTALL_FILES)
	$(INSTALL) -d $(exec_prefix)/$(target_alias)/lib
	for f in $(INSTALL_FILES); do \
	  echo $${f}; \
	  $(INSTALL_DATA) $${f} $(exec_prefix)/$(target_alias)/lib; \
	done

crt0.o: crt0.c sdktypes.h crt.h

gcrt0.o: crt0.c sdktypes.h crt.h
	$(CC) $(CFLAGS) -DDASHG -c -o $@ $(srcdir)/crt0.c

scrt0.o: scrt0.c

hooks.o: hooks.c sdktypes.h crt.h
gdbstub.o: gdbstub.c
palmos_GLib.o: palmos_GLib.c palmos_GLib.h

single_dreloc.o multi_dreloc.o \
multi_free.o reloc_chain.o: dreloc.c sdktypes.h crt.h
	$(CC) $(CFLAGS) -c -o $@ -DL`basename $@ .o` $(srcdir)/dreloc.c

ssingle_dreloc.o smulti_dreloc.o \
smulti_free.o sreloc_chain.o: dreloc.c sdktypes.h crt.h
	$(CC) $(CFLAGS) -mown-gp -c -o $@ -DL`basename $@ .o | sed -e s/^s//` $(srcdir)/dreloc.c

libcrt.a: $(CRTLIB_OBJS)
	-rm -f $@
	$(AR) cr $@ $+
	$(RANLIB) $@

libscrt.a: $(SCRTLIB_OBJS)
	-rm -f $@
	$(AR) cr $@ $+
	$(RANLIB) $@


NOEXCEPTLIB_OBJS = new.o newnt.o del.o vdel.o delnt.o vdelnt.o

libnoexcept.a: $(NOEXCEPTLIB_OBJS)
	-rm -f libnoexcept.a
	$(AR) cr $@ $+
	$(RANLIB) $@

$(NOEXCEPTLIB_OBJS): new12.cc
	$(CC) $(CFLAGS) -fno-exceptions -fno-rtti -c -o $@ -DL`basename $@ .o` $(srcdir)/new12.cc


clean:
	-rm *.o *.a

distclean: clean
	-rm Makefile
