# Makefile for prc-tools crt files.
#
# Copyright (c) 1998, 1999 Palm Computing, Inc. or its subsidiaries.
# All rights reserved.
#
# This is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.

srcdir = @srcdir@
VPATH = @srcdir@

prefix = @prefix@
exec_prefix = @exec_prefix@
target_alias = @target_alias@

INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@

BOOTSTRAP_SDKFLAGS = -DBOOTSTRAP -I$(srcdir)/../bootstrap -nopalmos
SDKFLAGS = @build_sdk@

CC = $(target_alias)-gcc
AR = $(target_alias)-ar
RANLIB = $(target_alias)-ranlib

# Don't use -fomit-frame-pointer just now: it's broken
# CFLAGS = -O5 -fomit-frame-pointer -fno-builtin -Wall -W
CFLAGS = -O5 -fno-builtin -Wall -W -I$(srcdir)/../include $(SDKFLAGS)

INSTALL_FILES = crt0.o gcrt0.o scrt0.o libcrt.a libcrt-owngp.a \
  libnoexcept.a libnfm.a

all: $(INSTALL_FILES)

install: $(INSTALL_FILES)
	$(INSTALL) -d $(exec_prefix)/$(target_alias)/lib
	for f in $(INSTALL_FILES); do \
	  echo $${f}; \
	  $(INSTALL_DATA) $${f} $(exec_prefix)/$(target_alias)/lib; \
	done


crt0.o: crt0.c ../include/NewTypes.h crt.h

gcrt0.o: crt0.c ../include/NewTypes.h crt.h
	$(CC) $(CFLAGS) -DDASHG -c -o $@ $(srcdir)/crt0.c

scrt0.o: scrt0.c ../include/NewTypes.h crt.h palmos_GLib.h
	$(CC) $(CFLAGS) -mown-gp -c -o $@ $(srcdir)/scrt0.c


CRTLIB_SRCS = \
  hooks.c gdbstub.c palmos_GLib.c dreloc.c \
  ../include/NewTypes.h crt.h

libcrt.a: $(CRTLIB_SRCS)
	$(MAKE) -f Make-multi VER="" CFLAGS="$(CFLAGS)" $@

libcrt-owngp.a: $(CRTLIB_SRCS)
	$(MAKE) -f Make-multi VER="-owngp" CFLAGS="$(CFLAGS) -mown-gp" $@


NOEXCEPTLIB_OBJS = new.o newnt.o del.o vdel.o delnt.o vdelnt.o

libnoexcept.a: $(NOEXCEPTLIB_OBJS)
	-rm -f libnoexcept.a
	$(AR) cr $@ $(NOEXCEPTLIB_OBJS)
	$(RANLIB) $@

$(NOEXCEPTLIB_OBJS): new12.cc
	$(CC) $(CFLAGS) -fno-exceptions -fno-rtti -c -o $@ -DL`basename $@ .o` $(srcdir)/new12.cc


NFMLIB_OBJS = \
  floatsisf.o floatdisf.o floatsidf.o floatdidf.o \
  extendsfdf2.o truncdfsf2.o \
  fixunssfsi.o fixsfsi.o fixunssfdi.o fixsfdi.o \
  fixunsdfsi.o fixdfsi.o fixunsdfdi.o fixdfdi.o \
  cmp_sf.o cmp_df.o cmpmap.o \
  negsf2.o addsf3.o mulsf3.o subsf3.o divsf3.o \
  negdf2.o adddf3.o muldf3.o subdf3.o divdf3.o

libnfm.a: $(NFMLIB_OBJS)
	-rm -f libnfm.a
	$(AR) cr libnfm.a $(NFMLIB_OBJS)
	$(RANLIB) libnfm.a

$(NFMLIB_OBJS): nfm.c
	$(CC) $(CFLAGS) -c -o $@ -DL__`basename $@ .o` $(srcdir)/nfm.c

clean:
	-rm *.o *.a

distclean: clean
	-rm Makefile Make-multi
