# Makefile for prc-tools documentation.
#
# Copyright 2001, 2002 John Marshall.
#
# This is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.

srcdir = @srcdir@
VPATH = @srcdir@

SHELL = /bin/sh

configured_subdirs = @subdirs@

prefix = @prefix@
exec_prefix = @exec_prefix@
palmdev_prefix = @palmdev_prefix@
infodir = @infodir@
htmldir = @htmldocs_prefix@

INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@

MAKEINFO = makeinfo
MAKEINFOFLAGS =

MAKEHTML = texi2html
MAKEHTMLFLAGS = -split node

all: info @htmldocs_enabled@

info: prc-tools.info

html: prc-tools.html index.html index.texi.html

install: install-info @install_htmldocs_enabled@

install-info: info
	$(INSTALL) -d $(infodir)
	-rm -f $(infodir)/prc-tools.info*
	for f in prc-tools.info*; do \
	  $(INSTALL_DATA) $${f} $(infodir)/$${f}; \
	done
	-if $(SHELL) -c 'install-info --version' >/dev/null 2>&1; then \
	  if [ -f $(infodir)/dir ]; then \
	    install-info --dir-file=$(infodir)/dir $(infodir)/prc-tools.info; \
	  else true; fi; \
	else true; fi

install-html: html
	$(INSTALL) -d $(htmldir)
	$(INSTALL_DATA) index.texi.html $(htmldir)/index.html
	-rm -rf $(htmldir)/texi
	$(INSTALL) -d $(htmldir)/texi
	for f in `ls *.html | grep -v '^index'`; do \
	  $(INSTALL_DATA) $$f $(htmldir)/texi/$$f; \
	done

.PHONY: all info html install install-info install-html clean


prc-tools.info: prc-tools.texi version.texi
	-@rm -f prc-tools.info*
	$(MAKEINFO) $(MAKEINFOFLAGS) -I $(srcdir) $(srcdir)/prc-tools.texi

prc-tools.dvi: prc-tools.texi version.texi
	texi2dvi -I $(srcdir) $(srcdir)/prc-tools.texi

prc-tools.ps: prc-tools.dvi
	dvips -o $@ $<

prc-tools.html: prc-tools.texi version.texi
	-@rm -f prc-tools[_.]*html
	$(MAKEHTML) $(MAKEHTMLFLAGS) -I $(srcdir) $(srcdir)/prc-tools.texi

# We also generate HTML copies of the various tools' user manuals.  Since
# they don't all (yet) provide HTML documentation targets in their makefiles,
# we do this with rather hackish fingers reaching from here over into the
# tool build directories.
#
# The nasty hackish part is that we've had to duplicate some of the *.texi
# dependency information here, and that information is subject to change as
# the other packages change.  But they'll probably change only slowly in
# this regard, and it's less horrible in practice (though not in theory!)
# than locally patching their makefiles for this, as we did in the past.

index.texi.html: index.html
	sed 's:href="./:href="texi/:' < index.html > index.texi.html

index.html: index.html.in html-subtargets
	awk '\
/@if-('`tr -cs 'a-z-' '|' < html-subtargets`'1)/ { discard = 0; next } \
/@if-/   { discard = 1 } \
!discard { print }' $(srcdir)/index.html.in | sed 's:"@:"./:' > index.html

.PHONY: html-binutils html-gdb html-gcc html-make

MKHTML = $(MAKEHTML) $(MAKEHTMLFLAGS)

html-binutils:
	-@rm -f binutils[_.]*html ld[_.]*html as[_.]*html
	[ -f $(srcdir)/../binutils/ld/configdoc.texi ] || \
	[ -f ../binutils/ld/configdoc.texi ] || (cd ../binutils; $(MAKE) info)
	$(MKHTML) -I ../binutils/binutils/doc \
	  -I $(srcdir)/../binutils/binutils/doc \
	  $(srcdir)/../binutils/binutils/doc/binutils.texi
	$(MKHTML) -I ../binutils/ld -I $(srcdir)/../binutils/ld \
	  -I $(srcdir)/../binutils/bfd/doc $(srcdir)/../binutils/ld/ld.texinfo
	$(MKHTML) -I ../binutils/gas/doc -I $(srcdir)/../binutils/gas/doc \
	  $(srcdir)/../binutils/gas/doc/as.texinfo

html-gdb:
	-@rm -f gdb[_.]*html
	[ -f ../gdb/gdb/doc/gdb-cfg.texi ] || (cd ../gdb; $(MAKE) info)
	$(MKHTML) -I ../gdb/gdb/doc -I $(srcdir)/../gdb/gdb/doc \
	  -I $(srcdir)/../gdb/readline/doc -I $(srcdir)/../gdb/gdb/mi \
	  $(srcdir)/../gdb/gdb/doc/gdb.texinfo

html-gcc:
	-@rm -f gcc[_.]*html cpp[_.]*html
	$(MKHTML) -D USERMANUALONLY -I $(srcdir)/../gcc/gcc \
	  $(srcdir)/../gcc/gcc/gcc.texi
	$(MKHTML) -I $(srcdir)/../gcc/gcc $(srcdir)/../gcc/gcc/cpp.texi

html-make:
	-@rm -f make[_.]*html
	# Expect one duplicate node (Conditional Syntax)
	$(MKHTML) -I $(srcdir)/../make $(srcdir)/../make/make.texinfo

html-subtargets:
	for d in $(configured_subdirs); do \
	  if [ -d ../$$d ]; then echo html-$$d; else :; fi; \
	done > $@
	$(MAKE) "MAKEHTML=$(MAKEHTML)" "MAKEHTMLFLAGS=$(MAKEHTMLFLAGS)" `cat $@`


clean:
	-rm -f prc-tools.info*
	-rm -f *.aux *.log *.toc *.fn *.vr *.cp *.pg *.ky *.tp *.fns
	-rm -f prc-tools.dvi prc-tools.ps
	-rm -f html-subtargets *.html
